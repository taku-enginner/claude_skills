# 使い方ガイド

動画をClaude Codeに安く渡すためのキーフレーム抽出ツールの使い方です。

## 目次

1. [セットアップ](#セットアップ)
2. [基本的な使い方](#基本的な使い方)
3. [オプション詳細](#オプション詳細)
4. [実践例](#実践例)
5. [Claude Codeとの連携](#claude-codeとの連携)
6. [トラブルシューティング](#トラブルシューティング)

---

## セットアップ

### 1. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

または個別にインストール:

```bash
pip install opencv-python numpy Pillow
```

### 2. 動作確認

```bash
python extract_keyframes.py --help
```

---

## 基本的な使い方

### 最もシンプルな使い方

```bash
python extract_keyframes.py 動画ファイル.mp4
```

これで `keyframes/` ディレクトリにキーフレームが出力されます。

### 出力例

```
動画情報:
  解像度: 1920x1080
  フレーム数: 150
  FPS: 30.00
  長さ: 5.00秒

抽出設定:
  類似度閾値: 0.85
  JPEG品質: 30
  スケール: 0.3

キーフレームを抽出中...

==================================================
抽出完了!
==================================================

項目              変更前         変更後
──────────────────────────────────────────────────
フレーム数        150枚          23枚
サイズ            1920x1080      576x324
容量              -              0.42MB

トークン計算:
  576x324 = 2,488トークン

Claude Opus料金:
  $0.0373 (約6円)

出力ディレクトリ: keyframes
抽出ファイル数: 23枚
```

---

## オプション詳細

### 全オプション一覧

| オプション | 短縮形 | 説明 | デフォルト | 推奨範囲 |
|------------|--------|------|------------|----------|
| `--output` | `-o` | 出力ディレクトリ | keyframes | - |
| `--threshold` | `-t` | 類似度閾値 | 0.85 | 0.80-0.95 |
| `--quality` | `-q` | JPEG品質 | 30 | 20-50 |
| `--scale` | `-s` | リサイズ倍率 | 0.3 | 0.2-0.5 |
| `--max-frames` | `-m` | 最大フレーム数 | 100 | 50-200 |

### 類似度閾値 (-t, --threshold)

フレーム間の類似度がこの値より**低い**場合に新しいキーフレームとして抽出します。

```bash
# 多くのフレームを抽出（細かい変化も検出）
python extract_keyframes.py video.mp4 -t 0.95

# 大きな変化のみ抽出（フレーム数を減らす）
python extract_keyframes.py video.mp4 -t 0.75
```

| 値 | 用途 |
|----|------|
| 0.95 | アニメーション、細かいUI変化を検出 |
| 0.85 | 一般的な画面遷移（推奨） |
| 0.75 | 大きなシーン切り替えのみ |

### JPEG品質 (-q, --quality)

画像の圧縮品質を指定します（1-100）。

```bash
# 高圧縮（ファイルサイズ小、画質低）
python extract_keyframes.py video.mp4 -q 20

# 低圧縮（ファイルサイズ大、画質高）
python extract_keyframes.py video.mp4 -q 50
```

| 値 | 用途 |
|----|------|
| 20-30 | コスト重視、テキスト認識が不要な場合 |
| 30-40 | バランス型（推奨） |
| 40-50 | 画質重視、細かいテキストがある場合 |

### スケール (-s, --scale)

画像のリサイズ倍率を指定します（0.0-1.0）。

```bash
# 小さくリサイズ（トークン大幅削減）
python extract_keyframes.py video.mp4 -s 0.2

# やや大きめ（詳細を保持）
python extract_keyframes.py video.mp4 -s 0.5
```

| 値 | 用途 |
|----|------|
| 0.2 | 全体の流れを把握したい場合 |
| 0.3 | 一般的な用途（推奨） |
| 0.5 | テキストや詳細を読み取りたい場合 |

---

## 実践例

### 例1: 画面遷移のバグ確認

画面録画からUIのバグを特定したい場合:

```bash
python extract_keyframes.py bug_recording.mp4 \
  -o bug_frames \
  -t 0.80 \
  -q 40 \
  -s 0.4
```

- 類似度閾値を低め（0.80）: 細かい変化も検出
- 品質を高め（40）: UIの詳細を保持
- スケールを大きめ（0.4）: テキストを読めるように

### 例2: 長い動画の概要把握

5分以上の長い動画の概要を把握したい場合:

```bash
python extract_keyframes.py long_video.mp4 \
  -o summary_frames \
  -t 0.70 \
  -q 25 \
  -s 0.25 \
  -m 50
```

- 類似度閾値を低く（0.70）: 大きな変化のみ
- 最大フレーム数を制限（50）: トークン数を抑える

### 例3: アニメーションの検証

UIアニメーションの動作を確認したい場合:

```bash
python extract_keyframes.py animation.mp4 \
  -o animation_frames \
  -t 0.95 \
  -q 35 \
  -s 0.5
```

- 類似度閾値を高く（0.95）: 細かい変化も検出
- スケールを大きめ（0.5）: アニメーションの詳細を確認

### 例4: 最小コストで渡す

とにかくコストを抑えたい場合:

```bash
python extract_keyframes.py video.mp4 \
  -o minimal_frames \
  -t 0.70 \
  -q 20 \
  -s 0.2 \
  -m 30
```

---

## Claude Codeとの連携

### 方法1: ディレクトリを直接指定

キーフレームを抽出後、Claude Codeで:

```
keyframes/ ディレクトリの画像を見て、画面遷移のバグを探してください
```

### 方法2: 特定のフレームを指定

```
keyframes/frame_0012.jpg と keyframes/frame_0013.jpg を比較して、
何が変わったか教えてください
```

### 方法3: 全体の流れを確認

```
keyframes/ にある全てのフレームを見て、
このアプリの画面遷移フローを説明してください
```

---

## トラブルシューティング

### エラー: 動画を開けません

```
エラー: 動画を開けません: video.mp4
```

**原因**: ファイルパスが間違っているか、サポートされていない形式

**解決策**:
- ファイルパスを確認
- サポート形式: MP4, AVI, MOV, MKV など
- コーデックの問題の場合は `ffmpeg` でMP4に変換

```bash
ffmpeg -i input.webm -c:v libx264 output.mp4
```

### エラー: パッケージがない

```
必要なパッケージをインストールしてください:
  pip install opencv-python numpy Pillow
```

**解決策**:

```bash
pip install opencv-python numpy Pillow
```

### フレームが多すぎる

**解決策**: 類似度閾値を下げる

```bash
python extract_keyframes.py video.mp4 -t 0.75
```

### フレームが少なすぎる

**解決策**: 類似度閾値を上げる

```bash
python extract_keyframes.py video.mp4 -t 0.95
```

### 画質が悪い

**解決策**: 品質とスケールを上げる

```bash
python extract_keyframes.py video.mp4 -q 50 -s 0.5
```

---

## コスト計算の目安

| 動画の長さ | 最適化前（概算） | 最適化後（概算） |
|------------|------------------|------------------|
| 5秒 | 約450円 | 約24円 |
| 30秒 | 約2,700円 | 約100円 |
| 1分 | 約5,400円 | 約180円 |
| 5分 | 約27,000円 | 約500円 |

※ 動画の内容や設定により変動します
